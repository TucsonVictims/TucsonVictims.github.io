<script>
const SHEETDB_URL = "https://sheetdb.io/api/v1/ul1a4ghd0iqpg";
const POLL_MS = 3000;
const chatEl = document.getElementById('chat');
const nickEl = document.getElementById('nick');
const msgEl = document.getElementById('message');
const sendBtn = document.getElementById('send');
const saveNickBtn = document.getElementById('saveNick');
const sndRecv = document.getElementById('sndRecv');
const sndSend = document.getElementById('sndSend');
let lastMessages = [];

if(localStorage.getItem('oldnet_nick'))
  nickEl.value = localStorage.getItem('oldnet_nick');

saveNickBtn.onclick = () => {
  const n = nickEl.value.trim() || 'User';
  localStorage.setItem('oldnet_nick', n);
  alert('Ник сохранён: ' + n);
};

sendBtn.onclick = sendMessage;
msgEl.addEventListener('keydown', e => { if(e.key === 'Enter') sendMessage(); });

async function sendMessage() {
  const nick = nickEl.value.trim() || 'User';
  const msg = msgEl.value.trim();
  if(!msg) return;
  const payload = { nick, message: msg, time: new Date().toISOString() };

  try {
    const res = await fetch(SHEETDB_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error(await res.text());
    msgEl.value = '';
    sndSend.play();
    await loadMessages();
  } catch(e) {
    console.error('Ошибка отправки:', e);
    const errDiv = document.createElement('div');
    errDiv.style.color = 'red';
    errDiv.textContent = '⚠ Ошибка отправки: ' + e.message;
    chatEl.appendChild(errDiv);
  }
}

async function loadMessages() {
  try {
    const res = await fetch(SHEETDB_URL + '?limit=50');
    const data = await res.json();
    const msgs = data.map(r => ({
      nick: r.nick || 'Anon',
      message: r.message || '',
      time: r.time || r.created_at || ''
    }));
    renderMessages(msgs);
  } catch(e) {
    console.error(e);
  }
}

function renderMessages(msgs) {
  if(JSON.stringify(msgs) === JSON.stringify(lastMessages)) return;
  const oldLen = lastMessages.length;
  const newLen = msgs.length;
  chatEl.innerHTML = '';
  msgs.forEach((m,i) => {
    const div = document.createElement('div');
    const me = (m.nick === localStorage.getItem('oldnet_nick'));
    div.className = 'message ' + (me?'me':'other');
    div.innerHTML = `<b>${escapeHTML(m.nick)}:</b> ${escapeHTML(m.message)} <span class='timestamp'>${formatTime(m.time)}</span>`;
    chatEl.appendChild(div);
  });
  chatEl.scrollTop = chatEl.scrollHeight;
  if (oldLen && newLen > oldLen) {
    sndRecv.play();
    const last = chatEl.lastElementChild;
    if(last) last.classList.add('blink');
  }
  lastMessages = msgs;
}

function formatTime(t) {
  if(!t) return '';
  const d = new Date(t);
  return d.toLocaleTimeString();
}

function escapeHTML(s) {
  return s.replace(/[&<>\"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#39;'
  }[c]));
}

setInterval(loadMessages, POLL_MS);
loadMessages();
</script>
